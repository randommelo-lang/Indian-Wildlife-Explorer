<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PDF Viewer</title>
    <link rel="stylesheet" href="viewer.css" />

    <script src="pdf.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.js";
    </script>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #1f1f1f;
            overflow: hidden;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 100;
            border-bottom: 1px solid #3a3a3a;
        }

        #toolbar button {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #toolbar button:hover {
            background: #064e3b;
        }

        #toolbar span {
            color: #fff;
            font-family: sans-serif;
        }

        #pdf-container {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        #pdf-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        #pdf-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        #pdf-container::-webkit-scrollbar-thumb {
            background-color: #059669;
            border-radius: 20px;
            border: 3px solid #2a2a2a;
        }

        #pdf-container::-webkit-scrollbar-thumb:hover {
            background-color: #064e3b;
        }

        .pdf-page {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            background: white;
        }

        #loading {
            color: #fff;
            font-family: sans-serif;
            font-size: 18px;
            text-align: center;
            padding: 40px;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <span id="pageInfo">Loading...</span>
        <button id="zoomOut">‚ûñ Zoom Out</button>
        <button id="zoomIn">‚ûï Zoom In</button>
    </div>

    <div id="pdf-container">
        <div id="loading">üìÑ Loading PDF...</div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.js";

        let pdfDoc = null;
        let scale = 1.2;
        const container = document.getElementById("pdf-container");

        function showError(message) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 0.5rem;">PDF Loading Error</h3>
                    <p style="color: #a1a1aa; max-width: 400px;">${message}</p>
                </div>
            `;
        }

        // Render a single page to a canvas
        async function renderPage(page, pageNum) {
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement("canvas");
            canvas.className = "pdf-page";
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.setAttribute("data-page", pageNum);

            const ctx = canvas.getContext("2d");
            await page.render({ canvasContext: ctx, viewport }).promise;

            return canvas;
        }

        // Render ALL pages at once
        async function renderAllPages() {
            container.innerHTML = '<div id="loading">üìÑ Rendering pages...</div>';

            const fragment = document.createDocumentFragment();

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const canvas = await renderPage(page, i);
                fragment.appendChild(canvas);

                // Update loading progress
                document.getElementById("loading").textContent =
                    `üìÑ Rendering page ${i} of ${pdfDoc.numPages}...`;
            }

            container.innerHTML = '';
            container.appendChild(fragment);

            document.getElementById("pageInfo").textContent =
                `${pdfDoc.numPages} pages | Scroll to read`;
        }

        // Re-render all pages (for zoom)
        async function reRenderAllPages() {
            if (!pdfDoc) return;

            document.getElementById("pageInfo").textContent = "Rendering...";

            const fragment = document.createDocumentFragment();

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const canvas = await renderPage(page, i);
                fragment.appendChild(canvas);
            }

            container.innerHTML = '';
            container.appendChild(fragment);

            document.getElementById("pageInfo").textContent =
                `${pdfDoc.numPages} pages | Zoom: ${Math.round(scale * 100)}%`;
        }

        function loadPdf(url) {
            console.log("üìÑ Loading PDF from:", url);

            if (!url || url === "undefined" || url === "null" || url.trim() === "") {
                showError("No PDF URL provided.");
                return;
            }

            const loadingTask = pdfjsLib.getDocument({
                url: url,
                withCredentials: false
            });

            loadingTask.promise.then(async pdf => {
                console.log("‚úÖ PDF loaded successfully, pages:", pdf.numPages);
                pdfDoc = pdf;
                await renderAllPages();
            }).catch(err => {
                console.error("‚ùå PDF load error:", err);
                showError(`Could not load PDF: ${err.message || "Unknown error"}`);
            });
        }

        // Receive PDF URL from Electron iframe message
        window.addEventListener("message", event => {
            console.log("üì© Received message:", event.data);
            if (event.data && event.data.fileUrl) {
                loadPdf(event.data.fileUrl);
            }
        });

        // Zoom controls
        document.getElementById("zoomIn").onclick = () => {
            scale += 0.2;
            reRenderAllPages();
        };

        document.getElementById("zoomOut").onclick = () => {
            if (scale <= 0.4) return;
            scale -= 0.2;
            reRenderAllPages();
        };

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
            const scrollAmount = 100;

            switch (e.key) {
                case "ArrowUp":
                    // Scroll up
                    container.scrollBy({ top: -scrollAmount, behavior: "smooth" });
                    e.preventDefault();
                    break;

                case "ArrowDown":
                    // Scroll down
                    container.scrollBy({ top: scrollAmount, behavior: "smooth" });
                    e.preventDefault();
                    break;

                case "ArrowLeft":
                    // Go to previous page (scroll to previous canvas)
                    scrollToPage("prev");
                    e.preventDefault();
                    break;

                case "ArrowRight":
                    // Go to next page (scroll to next canvas)
                    scrollToPage("next");
                    e.preventDefault();
                    break;

                case "+":
                case "=":
                    // Zoom in
                    scale += 0.2;
                    reRenderAllPages();
                    e.preventDefault();
                    break;

                case "-":
                case "_":
                    // Zoom out
                    if (scale > 0.4) {
                        scale -= 0.2;
                        reRenderAllPages();
                    }
                    e.preventDefault();
                    break;

                case "Home":
                    // Go to first page
                    container.scrollTo({ top: 0, behavior: "smooth" });
                    e.preventDefault();
                    break;

                case "End":
                    // Go to last page
                    container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
                    e.preventDefault();
                    break;
            }
        });

        // Scroll to next/previous page
        function scrollToPage(direction) {
            const pages = container.querySelectorAll(".pdf-page");
            if (pages.length === 0) return;

            const containerRect = container.getBoundingClientRect();
            const containerTop = container.scrollTop;

            let targetPage = null;

            if (direction === "next") {
                // Find the first page that starts below the current view
                for (let page of pages) {
                    const pageTop = page.offsetTop - container.offsetTop;
                    if (pageTop > containerTop + 50) {
                        targetPage = page;
                        break;
                    }
                }
            } else {
                // Find the page before the current view
                for (let i = pages.length - 1; i >= 0; i--) {
                    const pageTop = pages[i].offsetTop - container.offsetTop;
                    if (pageTop < containerTop - 50) {
                        targetPage = pages[i];
                        break;
                    }
                }
            }

            if (targetPage) {
                targetPage.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        }
    </script>
</body>

</html>